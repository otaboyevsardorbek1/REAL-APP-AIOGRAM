Otaboyev Sardorbek, [05.11.2025 12:15]
Men qanday qilib aiogramning ichki moduli yani dep link orqali katta va uzun holatda ishlaydigan va murakkab dep link yaratib undan foydalanishim mumkun
ChatGPT said:
Zoâ€˜r savol! ğŸ˜
Keling, buni bosqichma-bosqich tushuntiraman â€” qanday qilib aiogram ichida deep link (start parametri orqali) yaratish, uni murakkab maâ€™lumotlarni uzatish uchun ishlatish, va decode qilish mumkin.

ğŸ¯ 1. Deep link nima?
Telegram botda start parametri orqali foydalanuvchini biror maxsus sahifa yoki holatga yoâ€˜naltirish mumkin:

https://t.me/<bot_username>?start=<parametr>
Misol:

https://t.me/my_bot?start=abc123
abc123 â€” bu siz yuboradigan maâ€™lumot (masalan, foydalanuvchini taklif qilgan ID, yoki murakkab JSON maâ€™lumotlar).

âš™ï¸ 2. Aiogram yordamida ishlatish (misol uchun aiogram v3)
from aiogram import Bot, Dispatcher, types
from aiogram.filters import CommandStart
from aiogram.utils.deep_linking import decode_payload, create_start_link
import asyncio
import json

bot = Bot(token="YOUR_TOKEN")
dp = Dispatcher()

@dp.message(CommandStart(deep_link=True))
async def start_handler(message: types.Message, command: CommandStart):
    if command.args:
        data = decode_payload(command.args)
        # Decode qilingan maâ€™lumot (JSON string boâ€˜lsa, uni parse qilamiz)
        try:
            data = json.loads(data)
        except:
            pass
        await message.answer(f"Sizning dep-link maâ€™lumotingiz:\n<code>{data}</code>")
    else:
        await message.answer("Oddiy /start buyrugâ€˜i.")

async def main():
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
ğŸ”— 3. Uzun yoki murakkab deep link yaratish
Agar siz bir nechta qiymat, yoki murakkab maâ€™lumot (dict) uzatmoqchi boâ€˜lsangiz, ularni JSON formatda kodlab, soâ€˜ng base64 orqali kodlashingiz kerak.

Masalan:
from aiogram.utils.deep_linking import create_start_link
import json

async def create_complex_link(bot):
    payload = {
        "ref_id": 12345,
        "plan": "premium",
        "extra": {"lang": "uz", "utm": "telegram_ad_001"}
    }

    # JSON formatga o'tkazish
    payload_str = json.dumps(payload)

    link = await create_start_link(bot, payload_str)
    print("Sizning murakkab dep-linkingiz:")
    print(link)
Natija (taxminan):

https://t.me/my_bot?start=eyJyZWZfaWQiOiAxMjM0NSwgInBsYW4iOiAicHJlbWl1bSIsICJleHRyYSI6IHsibGFuZyI6ICJ1eiIsICJ1dG0iOiAidGVsZWdyYW1fYWRfMDAxIn19
ğŸ§  4. Qabul qilish tarafida uni decode qilish
Yuqoridagi start_handler misolida decode_payload() orqali bu maâ€™lumotni qayta ochish mumkin.
Shundan keyin uni json.loads() bilan Python dict ga aylantirasiz.

ğŸ’¡ Qoâ€˜shimcha maslahatlar
URL uzunligi limiti â€” Telegramâ€™da start parametri 64 belgidan oshmasligi kerak.
Shuning uchun murakkab maâ€™lumotlar uchun:

short_id yoki uuid ishlatib,

asosiy maâ€™lumotni server yoki bazada saqlang.

Deep link orqali faqat key yuboring.

Serverdagi yondashuv (tavsiya qilinadi):

# Deep link: https://t.me/my_bot?start=ref123
# Bazada ref123 -> {"user": 145, "campaign": "promo_5"} saqlanadi
Aiogram v2.x da ham oâ€˜xshash ishlaydi, faqat deep_linking funksiyalari boshqa joyda (aiogram.utils.deep_linking) boâ€˜ladi.

Agar xohlasangiz, sizga toâ€˜liq ishlaydigan namunaviy kod yozib beraman:
âœ… Deep link yaratish
âœ… Maâ€™lumotni decode qilish
âœ… Baza bilan ishlaydigan variant

Siz qaysi versiyani ishlatyapsiz: aiogram 2.x yoki aiogram 3.x?
Shunga qarab toâ€˜liq kodni moslab yozaman.

You said:
Men aiogram V3. X Dan foydalanaman va murakkab sep link namunasini yozib ber
ChatGPT said:
Ajoyib! ğŸ”¥
Demak siz aiogram v3.x dan foydalanayapsiz â€” bu holda biz zamonaviy Router, CommandStart, va create_start_link funksiyalaridan foydalanamiz.

Quyida murakkab (JSON shaklidagi) maâ€™lumotni uzatadigan toâ€˜liq ishlaydigan deep link (start link) namunasi keltirilgan.

ğŸš€ Toâ€˜liq namunaviy kod (main.py)
import asyncio
import json
from aiogram import Bot, Dispatcher, types, Router
from aiogram.filters import CommandStart
from aiogram.utils.deep_linking import create_start_link, decode_payload

# --- BOT SETUP ---
TOKEN = "YOUR_BOT_TOKEN"  # o'z tokeningizni yozing
bot = Bot(token=TOKEN, parse_m

Otaboyev Sardorbek, [05.11.2025 12:15]
ode="HTML")
dp = Dispatcher()
router = Router()
dp.include_router(router)


# --- DEEP LINK YARATISH (murakkab ma'lumot bilan) ---
@router.message(commands=["generate"])
async def generate_deeplink(message: types.Message):
    """Foydalanuvchi uchun murakkab deep-link yaratish"""
    # Murakkab ma'lumot (JSON shaklida)
    payload = {
        "ref_id": message.from_user.id,
        "plan": "premium",
        "utm": "telegram_ad_001",
        "extra": {"lang": "uz", "feature": "new_onboarding"},
    }

    # JSON stringga aylantiramiz
    payload_str = json.dumps(payload)

    # Deep link yaratamiz
    link = await create_start_link(bot, payload_str, encode=True)
    await message.answer(f"Mana sizning murakkab deep-linkingiz:\n\n{link}")


# --- DEEP LINK QABUL QILISH ( /start orqali ) ---
@router.message(CommandStart(deep_link=True))
async def start_handler(message: types.Message, command: CommandStart):
    """Foydalanuvchi deep-link orqali kirganda"""
    if command.args:
        try:
            # Base64 decode
            decoded = decode_payload(command.args)
            # JSON ni Python dict ga parse qilamiz
            data = json.loads(decoded)

            await message.answer(
                "<b>Siz deep-link orqali kirdingiz!</b>\n\n"
                f"<b>Ref ID:</b> {data.get('ref_id')}\n"
                f"<b>Tarif:</b> {data.get('plan')}\n"
                f"<b>UTM:</b> {data.get('utm')}\n"
                f"<b>Qo'shimcha:</b> {data.get('extra')}"
            )
        except Exception as e:
            await message.answer(f"Xatolik: {e}")
    else:
        await message.answer("Salom! Bu oddiy /start buyrugâ€˜i ğŸ™‚")


# --- POLLING ---
async def main():
    print("Bot ishga tushdi...")
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
ğŸ§© Qanday ishlaydi?
Siz botga /generate yuborasiz.
â†’ Bot sizga murakkab JSON maâ€™lumotni oâ€˜z ichiga olgan deep link yaratib beradi.

Masalan:

https://t.me/my_bot?start=eyJyZWZfaWQiOiAxMjM0NSwgInBsYW4iOiAicHJlbWl1bSIsICJ1dG0iOiAidGVsZWdyYW1fYWRfMDAxIiwiZXh0cmEiOiB7ImxhbmciOiAidXoiLCAiZmVhdHVyZSI6ICJuZXdfb25ib2FyZGluZyJ9fQ
Siz (yoki foydalanuvchi) shu linkni bosasiz.
â†’ /start <payload> bilan botga kiriladi.

start_handler funksiyasi command.args orqali bu maâ€™lumotni oladi, decode_payload bilan ochadi, json.loads() bilan dict ga aylantiradi, va foydalanuvchiga chiqadi.

âš ï¸ Muhim eslatmalar
Telegram start parametri 64 belgigacha boâ€˜lishi kerak, lekin create_start_link(..., encode=True) parametri Base64 orqali siqilgan maâ€™lumotni beradi â€” odatda bu sigâ€˜adi.
Juda katta JSON yubormang.

Agar sizga haqiqatan katta maâ€™lumot uzatish kerak boâ€˜lsa â€” id yoki token yuborib, maâ€™lumotni bazada saqlash variantini ishlating.

Xohlaysizmi, shu kodga SQLite bilan bazada deep link maâ€™lumotini saqlaydigan versiya ham yozib beray?
U holda siz cheklanmagan hajmdagi maâ€™lumot bilan deep-link ishlatishingiz mumkin.

You said:
Men id va loginni yuborishim mumkunmi masalan maxsulot id va order log id misolida 
ChatGPT said:
Ha, albatta mumkin! ğŸ”¥
Bu eng toâ€˜gâ€˜ri va tavsiya etilgan yondashuv â€” murakkab JSON yuborish oâ€˜rniga siz oddiy idlar (masalan, product_id, order_log_id) ni deep link orqali yuborasiz.

Keling, bu holatni toâ€˜liq va amaliy misol bilan tushuntiraman ğŸ‘‡

ğŸ¯ Maqsad
Sizda mahsulot bor (product_id=123), va sizga kerak:
ğŸ‘‰ https://t.me/<bot_username>?start=product_123_order_9876
koâ€˜rinishida link yaratish,
ğŸ‘‰ foydalanuvchi shu linkni bossa, bot u product_id va order_log_id ni ajratib olishini bilsin.

âš™ï¸ Toâ€˜liq Aiogram v3.x kodi
import asyncio
from aiogram import Bot, Dispatcher, Router, types
from aiogram.filters import CommandStart
from aiogram.utils.deep_linking import create_start_link, decode_payload

TOKEN = "YOUR_BOT_TOKEN"
bot = Bot(token=TOKEN, parse_mode="HTML")
dp = Dispatcher()
router = Router()
dp.include_router(router)


# --- Deep Link yaratish ---
@router.message(commands=["link"])
async def generate_link(message: types.Message):
    """
    Mahsulot ID va Order Log ID asosida deep link yaratish.
    Masalan: /link 123 9876
    """
    try:

Otaboyev Sardorbek, [05.11.2025 12:15]
args = message.text.split()
        if len(args) < 3:
            await message.answer("â— Foydalanish: <code>/link product_id order_log_id</code>")
            return

        product_id = args[1]
        order_log_id = args[2]

        # Payload â€” siz istagan maâ€™lumot
        payload = f"{product_id}_{order_log_id}"

        # Deep link yaratish
        deep_link = await create_start_link(bot, payload, encode=True)

        await message.answer(
            f"âœ… Sizning maxsus deep-linkingiz:\n\n"
            f"<a href='{deep_link}'>Bosish uchun shu yerni bosing</a>\n\n"
            f"<b>Payload:</b> <code>{payload}</code>"
        )
    except Exception as e:
        await message.answer(f"Xatolik: {e}")


# --- Deep Link orqali kirganda ---
@router.message(CommandStart(deep_link=True))
async def start_handler(message: types.Message, command: CommandStart):
    """
    /start <payload> orqali kirganda product_id va order_log_id ni ajratish
    """
    if command.args:
        decoded = decode_payload(command.args)
        try:
            product_id, order_log_id = decoded.split("_")
            await message.answer(
                f"ğŸ›’ Siz deep-link orqali kirdingiz!\n\n"
                f"<b>Mahsulot ID:</b> {product_id}\n"
                f"<b>Order Log ID:</b> {order_log_id}"
            )
        except ValueError:
            await message.answer(f"âš ï¸ Notoâ€˜gâ€˜ri payload: <code>{decoded}</code>")
    else:
        await message.answer("Salom! Bu oddiy /start buyrugâ€˜i ğŸ™‚")


# --- Polling ---
async def main():
    print("Bot ishga tushdi...")
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
ğŸ§© Qanday ishlaydi:
1ï¸âƒ£ Siz /link 123 9876 yuborasiz
â†’ Bot product_id=123, order_log_id=9876 dan payload = "123_9876" yasaydi
â†’ Deep link yaratadi:

https://t.me/YourBot?start=MTIzXzk4NzY
2ï¸âƒ£ Foydalanuvchi shu linkni bosadi
â†’ /start MTIzXzk4NzY bilan botga kiriladi
â†’ decode_payload() orqali â€œ123_9876â€ ochiladi
â†’ split("_") orqali ikkita qiymat ajratiladi
â†’ Natija chiqadi:

ğŸ›’ Siz deep-link orqali kirdingiz!
Mahsulot ID: 123
Order Log ID: 9876
âš¡ï¸ Qoâ€˜shimcha maslahatlar:
Agar sizga qoâ€˜shimcha maâ€™lumot kerak boâ€˜lsa (masalan, user_id, campaign), payloadni kengaytirish mumkin:

payload = f"{product_id}_{order_log_id}_{user_id}"
Keyin split("_") bilan ajratib olasiz.

Yoki yanada ishonchli variant â€” bu maâ€™lumotni bazaga saqlab, payloadga faqat bitta â€œtokenâ€ yuborish:

payload = f"key_{unique_id}"
Soâ€˜ngra foydalanuvchi deep-link orqali kirganda, siz unique_id boâ€˜yicha bazadan product/order maâ€™lumotini olasiz.
(Bu katta tizimlar uchun tavsiya etiladi.)

Xohlaysizmi, shu kodga SQLite bilan ishlaydigan, yaâ€™ni product/order maâ€™lumotini bazadan olib keladigan professional versiyasini ham yozib beray?
Shunda siz toâ€˜liq tizim darajasida deep link orqali buyurtma tizimini qura olasiz.

You said:
Ha imkon boricha murakkab sep link sxemasi va maÊ¼lumotlar bazasi SQLCHEMIY orqali ishlaydigan boÊ»lsin
ChatGPT said:
Zoâ€˜r! ğŸ”¥ Endi siz professional darajadagi murakkab deep-link (start parametri orqali) sxemani koâ€˜rasiz â€” bu yerda:

âœ… Aiogram v3.x ishlatiladi
âœ… Maâ€™lumotlar SQLAlchemy (async) orqali saqlanadi
âœ… Deep link foydalanuvchiga product_id, order_log_id yoki hatto boshqa maâ€™lumotlarni yuborish uchun ishlatiladi
âœ… Telegramdagi deep link orqali foydalanuvchi kirganda â€” maâ€™lumot bazadan olinadi

ğŸ§  Tuzilishi
Biz quyidagilarni qilamiz:

ğŸ“‚ bot/
 â”œâ”€â”€ main.py              # Asosiy bot kodi
 â”œâ”€â”€ db.py                # SQLAlchemy bilan bogâ€˜lanish
 â””â”€â”€ models.py            # Jadval modellari
âš™ï¸ models.py â€“ SQLAlchemy modeli
from sqlalchemy.ext.asyncio import AsyncAttrs
from sqlalchemy.orm import Mapped, mapped_column, declarative_base
from sqlalchemy import Integer, String, ForeignKey

Base = declarative_base(cls=AsyncAttrs)

class OrderLink(Base):
    __tablename__ = "order_links"

    id: Mapped[int] = mapped_column(Integer, primary_key=True, autoincrement=True)
    unique_key: Mapped[str] = mapped_column(String, unique=True)
    product_id: Mapped[int] = mapped_column(Integer)
    order_log_id: Mapped[int] = mapp

Otaboyev Sardorbek, [05.11.2025 12:15]
ed_column(Integer)
    created_by: Mapped[int] = mapped_column(Integer)
âš™ï¸ db.py â€“ Bazaga ulanish
from sqlalchemy.ext.asyncio import create_async_engine, async_sessionmaker, AsyncSession
from models import Base

DATABASE_URL = "sqlite+aiosqlite:///bot_data.db"  # SQLite (async variant)

engine = create_async_engine(DATABASE_URL, echo=False)
SessionLocal = async_sessionmaker(engine, expire_on_commit=False)

async def init_db():
    async with engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)

async def get_session() -> AsyncSession:
    async with SessionLocal() as session:
        yield session
ğŸ¤– main.py â€“ Bot logikasi (Aiogram v3)
import asyncio
import secrets
from aiogram import Bot, Dispatcher, Router, types
from aiogram.filters import CommandStart
from aiogram.utils.deep_linking import create_start_link, decode_payload
from sqlalchemy import select
from db import init_db, get_session
from models import OrderLink

TOKEN = "YOUR_BOT_TOKEN"
bot = Bot(token=TOKEN, parse_mode="HTML")
dp = Dispatcher()
router = Router()
dp.include_router(router)


# ğŸ”¹ /generate â€” yangi deep-link yaratish
@router.message(commands=["generate"])
async def generate_link(message: types.Message):
    """
    Foydalanuvchi product_id va order_log_id asosida deep link yaratadi.
    Masalan: /generate 123 9876
    """
    try:
        args = message.text.split()
        if len(args) < 3:
            await message.answer("â— Foydalanish: /generate <product_id> <order_log_id>")
            return

        product_id = int(args[1])
        order_log_id = int(args[2])
        created_by = message.from_user.id

        # Maâ€™lumotlar bazasiga saqlanadigan noyob key
        unique_key = secrets.token_urlsafe(8)

        # DBga yozish
        async for session in get_session():
            new_entry = OrderLink(
                unique_key=unique_key,
                product_id=product_id,
                order_log_id=order_log_id,
                created_by=created_by,
            )
            session.add(new_entry)
            await session.commit()

        # Deep link yaratish (unique_key ni payload sifatida yuboramiz)
        deep_link = await create_start_link(bot, unique_key, encode=True)
        await message.answer(
            f"âœ… Deep link yaratildi!\n\n"
            f"<b>Product ID:</b> {product_id}\n"
            f"<b>Order Log ID:</b> {order_log_id}\n\n"
            f"<a href='{deep_link}'>Linkni bosish uchun shu yerga bosing</a>"
        )

    except Exception as e:
        await message.answer(f"Xatolik: {e}")


# ğŸ”¹ /start <payload> orqali deep-linkni ishlatish
@router.message(CommandStart(deep_link=True))
async def start_deeplink(message: types.Message, command: CommandStart):
    """Foydalanuvchi deep-link orqali kirganda"""
    if not command.args:
        await message.answer("Salom! Bu oddiy /start buyrugâ€˜i.")
        return

    try:
        decoded = decode_payload(command.args)
        async for session in get_session():
            # Bazadan unique_key boâ€˜yicha qidiramiz
            result = await session.execute(
                select(OrderLink).where(OrderLink.unique_key == decoded)
            )
            order_link = result.scalar_one_or_none()

            if order_link:
                await message.answer(
                    f"ğŸ›’ <b>Siz maxsus link orqali kirdingiz!</b>\n\n"
                    f"<b>Product ID:</b> {order_link.product_id}\n"
                    f"<b>Order Log ID:</b> {order_link.order_log_id}\n"
                    f"<b>Yaratilgan foydalanuvchi:</b> {order_link.created_by}"
                )
            else:
                await message.answer("âš ï¸ Bu link endi mavjud emas yoki notoâ€˜gâ€˜ri.")
    except Exception as e:
        await message.answer(f"Xatolik: {e}")


# ğŸ”¹ Botni ishga tushirish
async def main():
    await init_db()
    print("âœ… Bot ishga tushdi...")
    await dp.start_polling(bot)


if __name__ == "__main__":
    asyncio.run(main())
ğŸ” Ishlash prinsipi:
1ï¸âƒ£ Siz /generate 123 9876 yuborasiz
Bot bazada quyidagi yozuvni yaratadi:

unique_key = "A9x2JK3sdQ"
produc

Otaboyev Sardorbek, [05.11.2025 12:15]
t_id = 123
order_log_id = 9876
created_by = 77777777 (foydalanuvchi ID)
Soâ€˜ngra https://t.me/MyBot?start=A9x2JK3sdQ koâ€˜rinishidagi deep linkni qaytaradi.

2ï¸âƒ£ Foydalanuvchi shu linkni bosadi
/start <payload> orqali botga kiradi

payload = A9x2JK3sdQ ni decode_payload() ochadi

Bot bazadan shu unique_keyni topadi

product_id va order_log_id ni foydalanuvchiga chiqaradi

ğŸ§  Afzalliklari
âœ… Deep link juda qisqa â€” faqat token (A9x2JK3sdQ)
âœ… Maâ€™lumot xavfsiz, chunki haqiqiy maâ€™lumotlar bazada saqlanadi
âœ… Har bir linkni foydalanuvchi bilan bogâ€˜lash mumkin
âœ… SQLAlchemy orqali async ishlash (tez va zamonaviy)

âš¡ Qoâ€˜shimcha rivojlantirish gâ€˜oyalari
Agar xohlasangiz, quyidagilarni qoâ€˜shish mumkin:

Deep linkni bir martalik qilish (is_used flag qoâ€˜shish)

Har bir bosilgan deep linkni loglash

Maâ€™lumotlarni PostgreSQL yoki MySQL da saqlash

Admin panel orqali deep linklar roâ€˜yxatini koâ€˜rish

Xohlaysizmi, men shu kodga â€œbir martalik deep linkâ€ (yaâ€™ni ishlatilgandan keyin avtomatik oâ€˜chadigan) qoâ€˜shimchasini yozib beray?
Bu real loyihalarda xavfsizlik uchun juda foydali boâ€˜ladi.

You said:
Ha bir martalik deplink namunasini qoÊ»shib ber
ChatGPT said:
Zoâ€˜r! ğŸ’ª
Endi biz oldingi SQLAlchemy + Aiogram v3 deep-link sxemasiga
âœ… bir martalik ishlatiladigan deep link (one-time link) funksiyasini qoâ€˜shamiz.

Bunda deep link:

faqat bir marta ishlaydi;

foydalanuvchi uni bosgach, bazada is_used=True boâ€˜ladi;

agar kimdir linkni ikkinchi marta ishlatmoqchi boâ€˜lsa â€” bot â€œlink ishlatilganâ€ deb javob beradi.

ğŸ§© Yakuniy, professional main.py kodi
import asyncio
import secrets
from aiogram import Bot, Dispatcher, Router, types
from aiogram.filters import CommandStart
from aiogram.utils.deep_linking import create_start_link, decode_payload
from sqlalchemy import select, update
from db import init_db, get_session
from models import OrderLink

TOKEN = "YOUR_BOT_TOKEN"
bot = Bot(token=TOKEN, parse_mode="HTML")
dp = Dispatcher()
router = Router()
dp.include_router(router)


# ğŸ”¹ /generate â€” yangi deep-link yaratish
@router.message(commands=["generate"])
async def generate_link(message: types.Message):
    """
    Yangi deep link yaratadi:
    /generate <product_id> <order_log_id>
    """
    try:
        args = message.text.split()
        if len(args) < 3:
            await message.answer("â— Foydalanish: /generate <product_id> <order_log_id>")
            return

        product_id = int(args[1])
        order_log_id = int(args[2])
        created_by = message.from_user.id

        # Noyob identifikator (payload)
        unique_key = secrets.token_urlsafe(8)

        # Bazaga yozamiz
        async for session in get_session():
            new_entry = OrderLink(
                unique_key=unique_key,
                product_id=product_id,
                order_log_id=order_log_id,
                created_by=created_by,
                is_used=False
            )
            session.add(new_entry)
            await session.commit()

        # Deep link yaratish
        deep_link = await create_start_link(bot, unique_key, encode=True)
        await message.answer(
            f"âœ… Bir martalik deep-link yaratildi!\n\n"
            f"<b>Product ID:</b> {product_id}\n"
            f"<b>Order Log ID:</b> {order_log_id}\n\n"
            f"<a href='{deep_link}'>ğŸ‘‰ Linkni bosish uchun shu yerga bosing</a>"
        )

    except Exception as e:
        await message.answer(f"Xatolik: {e}")


# ğŸ”¹ /start <payload> â€” foydalanuvchi deep-link orqali kirganda
@router.message(CommandStart(deep_link=True))
async def start_deeplink(message: types.Message, command: CommandStart):
    """Foydalanuvchi deep link orqali kirganda"""
    if not command.args:
        await message.answer("Salom! Bu oddiy /start buyrugâ€˜i ğŸ™‚")
        return

    try:
        decoded = decode_payload(command.args)

        async for session in get_session():
            # Bazadan linkni qidiramiz
            result = await session.execute(
                select(OrderLink).where(OrderLink.unique_key == decoded)
            )
            order_link = result.scalar_one_or_none()

            if not ord

Otaboyev Sardorbek, [05.11.2025 12:15]
er_link:
                await message.answer("âš ï¸ Bunday deep link mavjud emas.")
                return

            # Agar allaqachon ishlatilgan boâ€˜lsa
            if order_link.is_used:
                await message.answer("ğŸš« Bu link allaqachon ishlatilgan!")
                return

            # Bir martalik link â€” endi uni ishlatilgan deb belgilaymiz
            await session.execute(
                update(OrderLink)
                .where(OrderLink.id == order_link.id)
                .values(is_used=True)
            )
            await session.commit()

            await message.answer(
                f"ğŸ‰ Siz deep-link orqali kirdingiz!\n\n"
                f"<b>Product ID:</b> {order_link.product_id}\n"
                f"<b>Order Log ID:</b> {order_link.order_log_id}\n"
                f"<b>Yaratilgan foydalanuvchi:</b> {order_link.created_by}\n\n"
                f"âœ… Bu link endi ishlatilgan deb belgilandi."
            )

    except Exception as e:
        await message.answer(f"Xatolik: {e}")


# ğŸ”¹ Botni ishga tushirish
async def main():
    await init_db()
    print("âœ… Bot ishga tushdi...")
    await dp.start_polling(bot)


if __name__ == "__main__":
    asyncio.run(main())
âš™ï¸ models.py (yangilangan)
from sqlalchemy.ext.asyncio import AsyncAttrs
from sqlalchemy.orm import Mapped, mapped_column, declarative_base
from sqlalchemy import Integer, String, Boolean

Base = declarative_base(cls=AsyncAttrs)

class OrderLink(Base):
    __tablename__ = "order_links"

    id: Mapped[int] = mapped_column(Integer, primary_key=True, autoincrement=True)
    unique_key: Mapped[str] = mapped_column(String, unique=True)
    product_id: Mapped[int] = mapped_column(Integer)
    order_log_id: Mapped[int] = mapped_column(Integer)
    created_by: Mapped[int] = mapped_column(Integer)
    is_used: Mapped[bool] = mapped_column(Boolean, default=False)
âš™ï¸ db.py (oâ€˜zgarmagan)
from sqlalchemy.ext.asyncio import create_async_engine, async_sessionmaker, AsyncSession
from models import Base

DATABASE_URL = "sqlite+aiosqlite:///bot_data.db"

engine = create_async_engine(DATABASE_URL, echo=False)
SessionLocal = async_sessionmaker(engine, expire_on_commit=False)

async def init_db():
    async with engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)

async def get_session() -> AsyncSession:
    async with SessionLocal() as session:
        yield session
ğŸ§© Qanday ishlaydi
1ï¸âƒ£ /generate 123 9876
Bot bazada quyidagi yozuvni yaratadi:

unique_key = "ABC123xyz"
product_id = 123
order_log_id = 9876
is_used = False
Sizga https://t.me/YourBot?start=ABC123xyz koâ€˜rinishidagi bir martalik link yuboradi.

2ï¸âƒ£ Foydalanuvchi shu linkni bosadi:
Bot bazadan unique_key ni topadi.

is_used = False boâ€˜lsa â†’ ishlaydi va keyin True qilib belgilaydi.

Agar keyingi safar shu link bosilsa â†’ â€œğŸš« Link allaqachon ishlatilganâ€ deb javob beradi.

âš¡ Afzalliklari
âœ… Har bir deep-link bir marta ishlatiladi
âœ… Maâ€™lumotlar xavfsiz â€” faqat unique_key yuboriladi
âœ… SQLAlchemy orqali asinxron, real bazaviy boshqaruv
âœ… Har bir linkni foydalanuvchi bilan bogâ€˜lash mumkin

Xohlaysizmi, shu tizimga linklar statistikasi (qancha ishlatilgan, kim yaratgan, qachon ishlatilgan) uchun qoâ€˜shimcha created_at va used_at ustunlarini ham qoâ€˜shib beray?
Bu bilan siz â€œdeep-link tahlilâ€ (analytics) funksiyasini ham olasiz.

You said:
Ha menga statistika kerak
ChatGPT said:
Zoâ€˜r! ğŸš€
Endi siz haqiqiy deep-link boshqaruv tizimiga ega boâ€˜lasiz:
âœ… Aiogram v3
âœ… SQLAlchemy (async)
âœ… Bir martalik deep-link
âœ… Statistika (yaratilgan va ishlatilgan vaqtlar)

ğŸ“¦ Yakuniy professional tizim tuzilmasi
ğŸ“‚ bot/
 â”œâ”€â”€ main.py        # Aiogram logikasi
 â”œâ”€â”€ db.py          # SQLAlchemy ulanishi
 â””â”€â”€ models.py      # Model va struktura
âš™ï¸ models.py â€” model (statistika qoâ€˜shilgan)
from datetime import datetime
from sqlalchemy.ext.asyncio import AsyncAttrs
from sqlalchemy.orm import Mapped, mapped_column, declarative_base
from sqlalchemy import Integer, String, Boolean, DateTime

Base = declarative_base(cls=AsyncAttrs)

class OrderLink(Base):
    __tablename__ = "order_links"

    id: Mapped[i

Otaboyev Sardorbek, [05.11.2025 12:15]
nt] = mapped_column(Integer, primary_key=True, autoincrement=True)
    unique_key: Mapped[str] = mapped_column(String, unique=True)
    product_id: Mapped[int] = mapped_column(Integer)
    order_log_id: Mapped[int] = mapped_column(Integer)
    created_by: Mapped[int] = mapped_column(Integer)
    is_used: Mapped[bool] = mapped_column(Boolean, default=False)
    created_at: Mapped[datetime] = mapped_column(DateTime, default=datetime.utcnow)
    used_at: Mapped[datetime | None] = mapped_column(DateTime, nullable=True)
âš™ï¸ db.py â€” baza ulanishi
from sqlalchemy.ext.asyncio import create_async_engine, async_sessionmaker, AsyncSession
from models import Base

DATABASE_URL = "sqlite+aiosqlite:///bot_data.db"

engine = create_async_engine(DATABASE_URL, echo=False)
SessionLocal = async_sessionmaker(engine, expire_on_commit=False)

async def init_db():
    async with engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)

async def get_session() -> AsyncSession:
    async with SessionLocal() as session:
        yield session
ğŸ¤– main.py â€” Aiogram logikasi (statistika bilan)
import asyncio
import secrets
from datetime import datetime
from aiogram import Bot, Dispatcher, Router, types
from aiogram.filters import CommandStart
from aiogram.utils.deep_linking import create_start_link, decode_payload
from sqlalchemy import select, update, func
from db import init_db, get_session
from models import OrderLink

TOKEN = "YOUR_BOT_TOKEN"
bot = Bot(token=TOKEN, parse_mode="HTML")
dp = Dispatcher()
router = Router()
dp.include_router(router)


# ğŸ”¹ /generate â€” yangi deep-link yaratish
@router.message(commands=["generate"])
async def generate_link(message: types.Message):
    """Yangi bir martalik deep-link yaratadi"""
    args = message.text.split()
    if len(args) < 3:
        await message.answer("â— Foydalanish: /generate <product_id> <order_log_id>")
        return

    product_id = int(args[1])
    order_log_id = int(args[2])
    created_by = message.from_user.id
    unique_key = secrets.token_urlsafe(8)

    async for session in get_session():
        new_link = OrderLink(
            unique_key=unique_key,
            product_id=product_id,
            order_log_id=order_log_id,
            created_by=created_by,
        )
        session.add(new_link)
        await session.commit()

    deep_link = await create_start_link(bot, unique_key, encode=True)
    await message.answer(
        f"âœ… Bir martalik deep-link yaratildi!\n\n"
        f"<b>Product ID:</b> {product_id}\n"
        f"<b>Order Log ID:</b> {order_log_id}\n"
        f"<b>Yaratgan foydalanuvchi:</b> {created_by}\n\n"
        f"<a href='{deep_link}'>ğŸ‘‰ Linkni bosish uchun shu yerga bosing</a>"
    )


# ğŸ”¹ /start <payload> â€” foydalanuvchi deep-link orqali kirganda
@router.message(CommandStart(deep_link=True))
async def start_deeplink(message: types.Message, command: CommandStart):
    """Deep-link orqali kirish"""
    if not command.args:
        await message.answer("Salom! Bu oddiy /start buyrugâ€˜i ğŸ™‚")
        return

    decoded = decode_payload(command.args)
    async for session in get_session():
        result = await session.execute(select(OrderLink).where(OrderLink.unique_key == decoded))
        order_link = result.scalar_one_or_none()

        if not order_link:
            await message.answer("âš ï¸ Bunday deep-link mavjud emas.")
            return

        if order_link.is_used:
            await message.answer(
                "ğŸš« Bu link allaqachon ishlatilgan!\n\n"
                f"<b>Ishtirokchi:</b> {order_link.created_by}\n"
                f"<b>Product ID:</b> {order_link.product_id}\n"
                f"<b>Order ID:</b> {order_link.order_log_id}\n"
                f"<b>Ishlatilgan vaqt:</b> {order_link.used_at}"
            )
            return

        # Linkni ishlatilgan deb belgilaymiz
        await session.execute(
            update(OrderLink)
            .where(OrderLink.id == order_link.id)
            .values(is_used=True, used_at=datetime.utcnow())
        )
        await session.commit()

        await message.answer(

Otaboyev Sardorbek, [05.11.2025 12:15]
f"ğŸ¯ Siz deep-link orqali kirdingiz!\n\n"
            f"<b>Product ID:</b> {order_link.product_id}\n"
            f"<b>Order Log ID:</b> {order_link.order_log_id}\n\n"
            f"âœ… Bu link endi ishlatilgan deb belgilandi."
        )


# ğŸ”¹ /stats â€” foydalanuvchi yaratgan linklar statistikasi
@router.message(commands=["stats"])
async def stats_handler(message: types.Message):
    """Foydalanuvchining deep-link statistikasi"""
    user_id = message.from_user.id
    async for session in get_session():
        total_links = await session.scalar(
            select(func.count(OrderLink.id)).where(OrderLink.created_by == user_id)
        )
        used_links = await session.scalar(
            select(func.count(OrderLink.id)).where(
                OrderLink.created_by == user_id, OrderLink.is_used.is_(True)
            )
        )
        active_links = total_links - used_links

        # Soâ€˜nggi 5 ta linkni koâ€˜rsatish
        result = await session.execute(
            select(OrderLink)
            .where(OrderLink.created_by == user_id)
            .order_by(OrderLink.created_at.desc())
            .limit(5)
        )
        links = result.scalars().all()

        text = (
            f"ğŸ“Š <b>Sizning statistikangiz</b>\n\n"
            f"ğŸ”¹ Jami linklar: {total_links}\n"
            f"ğŸŸ¢ Faol (ishlatilmagan): {active_links}\n"
            f"ğŸ”´ Ishlatilgan: {used_links}\n\n"
        )

        if links:
            text += "<b>ğŸ§¾ Soâ€˜nggi 5 ta link:</b>\n"
            for link in links:
                status = "âœ… Ishlatilgan" if link.is_used else "ğŸŸ¢ Faol"
                text += (
                    f"â€¢ Product {link.product_id} / Order {link.order_log_id} "
                    f"({status})\n"
                    f"  ğŸ•“ {link.created_at.strftime('%Y-%m-%d %H:%M:%S')}\n"
                )
        else:
            text += "Siz hali birorta link yaratmagansiz."

        await message.answer(text)


# ğŸ”¹ Botni ishga tushirish
async def main():
    await init_db()
    print("âœ… Bot ishga tushdi...")
    await dp.start_polling(bot)


if __name__ == "__main__":
    asyncio.run(main())
ğŸ§  Natijada sizda:
Funksiya Tavsif
/generate <product_id> <order_log_id> Bir martalik deep link yaratadi
/start <payload> Foydalanuvchi link orqali kiradi, bot bazadan maâ€™lumotni topadi
/stats Siz yaratgan barcha linklar statistikasi (jami, faol, ishlatilgan, tarix)
ğŸ“Š Misol
/generate 101 550
â¡ï¸ Bot javobi:

âœ… Bir martalik deep-link yaratildi!
Product ID: 101
Order Log ID: 550
Yaratgan foydalanuvchi: 777777777
ğŸ‘‰ https://t.me/YourBot?start=ABcdEfGh
Agar foydalanuvchi shu linkni bossa â†’
Bot bazadan maâ€™lumotni olib, is_used=True, used_at=datetime.utcnow() deb belgilaydi.

âš¡ Kengaytirish gâ€˜oyalari
/stats all orqali barcha foydalanuvchilarning statistikasi (admin uchun)

Har bir deep link uchun QR-kod yaratish

Linkni muayyan muddatgacha faol saqlash (masalan, 24 soat)

PostgreSQL yoki MySQL ga oâ€˜tish (SQLite kichik loyihalar uchun yetarli)

Xohlaysizmi, shu kodga QR-code generator (yaâ€™ni deep linkdan avtomatik QR yaratish) funksiyasini ham qoâ€˜shib beray?
Bu marketing, buyurtma yoki reklama tizimlarida juda foydali boâ€˜ladi.

You said:
Ha buning ilojisi bormi
ChatGPT said:
Albatta bor! ğŸ”¥
Siz yaratgan har bir deep-link uchun avtomatik QR-kod yaratish â€” juda foydali funksiya:

Reklama uchun (banner, katalog, vizitka)

Offline joylardan (doâ€˜kon, event, buklet) botga tez kirish uchun

Keling, mavjud bir martalik deep-link + statistika tizimiga QR-code generatorni ham qoâ€˜shamiz.

ğŸ§© Fikr sxemasi
Biz quyidagini qilamiz:

/generate <product_id> <order_log_id> yuboriladi

Bot deep-link yaratadi

Oâ€˜sha linkdan QR-kod rasmini generatsiya qiladi

Foydalanuvchiga QR + link yuboradi

âš™ï¸ Kerakli kutubxonalar
Sizga qoâ€˜shimcha kutubxona kerak boâ€˜ladi:

pip install qrcode[pil] pillow
âš™ï¸ main.py â€” QR generatorli toâ€˜liq kod
Quyidagi kod sizning avvalgi bazaviy tizimga mos keladi:

import asyncio
import secrets
from datetime import datetime
import qrcode
from aiogram import Bot, Dispatcher, Router, types
from aiogram.filters import CommandStart
from aiogram.utils.d

Otaboyev Sardorbek, [05.11.2025 12:15]
eep_linking import create_start_link, decode_payload
from sqlalchemy import select, update, func
from db import init_db, get_session
from models import OrderLink

TOKEN = "YOUR_BOT_TOKEN"
bot = Bot(token=TOKEN, parse_mode="HTML")
dp = Dispatcher()
router = Router()
dp.include_router(router)


# ğŸ”¹ QR-code yaratish funksiyasi
def generate_qr(link: str, filename: str) -> str:
    """Deep linkdan QR-kod faylini yaratadi va saqlaydi"""
    img = qrcode.make(link)
    filepath = f"qr_codes/{filename}.png"

    import os
    os.makedirs("qr_codes", exist_ok=True)
    img.save(filepath)

    return filepath


# ğŸ”¹ /generate â€” yangi deep-link + QR yaratish
@router.message(commands=["generate"])
async def generate_link(message: types.Message):
    """Yangi bir martalik deep-link yaratadi va QR-kod generatsiya qiladi"""
    args = message.text.split()
    if len(args) < 3:
        await message.answer("â— Foydalanish: /generate <product_id> <order_log_id>")
        return

    product_id = int(args[1])
    order_log_id = int(args[2])
    created_by = message.from_user.id
    unique_key = secrets.token_urlsafe(8)

    async for session in get_session():
        new_link = OrderLink(
            unique_key=unique_key,
            product_id=product_id,
            order_log_id=order_log_id,
            created_by=created_by,
        )
        session.add(new_link)
        await session.commit()

    # Deep-link yaratamiz
    deep_link = await create_start_link(bot, unique_key, encode=True)

    # QR-kod yaratamiz
    qr_path = generate_qr(deep_link, unique_key)

    # QR bilan yuboramiz
    await message.answer_photo(
        photo=types.FSInputFile(qr_path),
        caption=(
            f"âœ… Bir martalik deep-link yaratildi!\n\n"
            f"<b>Product ID:</b> {product_id}\n"
            f"<b>Order Log ID:</b> {order_log_id}\n"
            f"<b>Yaratgan foydalanuvchi:</b> {created_by}\n\n"
            f"<b>Link:</b> {deep_link}"
        ),
    )


# ğŸ”¹ /start <payload> â€” foydalanuvchi deep-link orqali kirganda
@router.message(CommandStart(deep_link=True))
async def start_deeplink(message: types.Message, command: CommandStart):
    """Deep-link orqali kirish"""
    if not command.args:
        await message.answer("Salom! Bu oddiy /start buyrugâ€˜i ğŸ™‚")
        return

    decoded = decode_payload(command.args)
    async for session in get_session():
        result = await session.execute(select(OrderLink).where(OrderLink.unique_key == decoded))
        order_link = result.scalar_one_or_none()

        if not order_link:
            await message.answer("âš ï¸ Bunday deep-link mavjud emas.")
            return

        if order_link.is_used:
            await message.answer(
                f"ğŸš« Bu link allaqachon ishlatilgan!\n\n"
                f"<b>Product ID:</b> {order_link.product_id}\n"
                f"<b>Order ID:</b> {order_link.order_log_id}\n"
                f"<b>Ishlatilgan vaqt:</b> {order_link.used_at}"
            )
            return

        # Linkni ishlatilgan deb belgilaymiz
        await session.execute(
            update(OrderLink)
            .where(OrderLink.id == order_link.id)
            .values(is_used=True, used_at=datetime.utcnow())
        )
        await session.commit()

        await message.answer(
            f"ğŸ¯ Siz deep-link orqali kirdingiz!\n\n"
            f"<b>Product ID:</b> {order_link.product_id}\n"
            f"<b>Order Log ID:</b> {order_link.order_log_id}\n"
            f"âœ… Bu link endi ishlatilgan deb belgilandi."
        )


# ğŸ”¹ /stats â€” foydalanuvchining statistikasi
@router.message(commands=["stats"])
async def stats_handler(message: types.Message):
    """Foydalanuvchi yaratgan deep-linklar statistikasi"""
    user_id = message.from_user.id
    async for session in get_session():
        total_links = await session.scalar(
            select(func.count(OrderLink.id)).where(OrderLink.created_by == user_id)
        )
        used_links = await session.scalar(
            select(func.count(OrderLink.id)).where(
                OrderLink.created_by == user_id, OrderLink.is_used.is

Otaboyev Sardorbek, [05.11.2025 12:15]
_(True)
            )
        )
        active_links = total_links - used_links

        result = await session.execute(
            select(OrderLink)
            .where(OrderLink.created_by == user_id)
            .order_by(OrderLink.created_at.desc())
            .limit(5)
        )
        links = result.scalars().all()

        text = (
            f"ğŸ“Š <b>Sizning statistikangiz</b>\n\n"
            f"ğŸ”¹ Jami linklar: {total_links}\n"
            f"ğŸŸ¢ Faol (ishlatilmagan): {active_links}\n"
            f"ğŸ”´ Ishlatilgan: {used_links}\n\n"
        )

        if links:
            text += "<b>ğŸ§¾ Soâ€˜nggi 5 ta link:</b>\n"
            for link in links:
                status = "âœ… Ishlatilgan" if link.is_used else "ğŸŸ¢ Faol"
                text += (
                    f"â€¢ Product {link.product_id} / Order {link.order_log_id} ({status})\n"
                    f"  ğŸ•“ {link.created_at.strftime('%Y-%m-%d %H:%M:%S')}\n"
                )
        else:
            text += "Siz hali birorta link yaratmagansiz."

        await message.answer(text)


# ğŸ”¹ Botni ishga tushirish
async def main():
    await init_db()
    print("âœ… Bot ishga tushdi...")
    await dp.start_polling(bot)


if __name__ == "__main__":
    asyncio.run(main())
ğŸ“¸ Natija:
Siz yuborasiz:
/generate 101 555
Bot javobi:
Sizga QR-kod rasmi (PNG fayl) yuboradi

Rasm tagida:

âœ… Bir martalik deep-link yaratildi!
Product ID: 101
Order Log ID: 555
Link: https://t.me/MyBot?start=A9BcDeFg
Foydalanuvchi QRâ€™ni skaner qilsa:
Telegram avtomatik ochadi: t.me/MyBot?start=A9BcDeFg

Bot maâ€™lumotni bazadan topadi va ishlov beradi.

ğŸ“Š Foyda
âœ… Har bir link uchun vizual QR yaratiladi
âœ… Offline reklama va marketingda ishlatish mumkin
âœ… QRâ€™lar qr_codes/ papkasida saqlanadi
âœ… Barcha statistikalar (yaratilgan, ishlatilgan, sana) saqlanadi

Xohlaysizmi, men sizga shunga /qr <product_id> <order_log_id> nomli maxsus buyruq qoâ€˜shib beray, u faqat QR yaratadi (linkni yangilamasdan)?
Bu marketing tizimlarda tez QR chiqarish uchun juda foydali.

You said:
Ha menga ikoni boÊ»lsa man. Py ni ichiga oÊ»zim qoÊ»shib olaman shuning uchun  uni alohida funqsiya qilib yaratib bera ver iltimos
ChatGPT said:
Zoâ€˜r, juda toâ€˜gâ€˜ri yondashuv! ğŸ’ª
Demak, sizga faqat QR-kod yaratish funksiyasi kerak â€” uni main.py ichiga yoki alohida utils.py fayliga qoâ€˜shib olasiz.

Quyida siz uchun modulli, mustaqil ishlaydigan universal QR-kod generatsiya funksiyasi tayyorlab beraman.
U deep-link uchun ikon (logo) bilan markazga joylashtirilgan professional QR yaratadi.

ğŸ§  Funksiya: generate_qr_with_logo(link: str, filename: str, logo_path: str | None = None)
import os
import qrcode
from qrcode.image.styledpil import StyledPilImage
from qrcode.image.styles.moduledrawers import RoundedModuleDrawer
from qrcode.image.styles.colormasks import RadialGradiantColorMask
from PIL import Image

def generate_qr_with_logo(link: str, filename: str, logo_path: str | None = None) -> str:
    """
    Deep-link uchun professional QR-kod yaratadi.
    (markazda logo boâ€˜lishi mumkin)
    
    Parametrlar:
        link (str): Telegram deep-link yoki istalgan URL
        filename (str): Saqlanadigan fayl nomi (logo boâ€˜lmasa ham ishlaydi)
        logo_path (str | None): markazdagi logotip (PNG/JPG)
    
    Natija:
        str: Yaratilgan QR fayl yoâ€˜li (PNG format)
    """

    # ğŸ“ QR papkasini yaratamiz
    os.makedirs("qr_codes", exist_ok=True)
    qr_path = f"qr_codes/{filename}.png"

    # ğŸ”¹ QR obyekt
    qr = qrcode.QRCode(
        version=2,
        error_correction=qrcode.constants.ERROR_CORRECT_H,  # yuqori aniqlik
        box_size=12,
        border=4,
    )

    qr.add_data(link)
    qr.make(fit=True)

    # ğŸ”¹ QR ni biroz chiroyliroq qilish (yumaloq modullar + gradient)
    qr_img = qr.make_image(
        image_factory=StyledPilImage,
        module_drawer=RoundedModuleDrawer(),
        color_mask=RadialGradiantColorMask(),
    )

    # ğŸ”¹ Agar logotip berilgan boâ€˜lsa â€” markazga joylashtiramiz
    if logo_path and os.path.exists(logo_path):
        logo = Image.open(logo_path)
        qr_width, qr_height = qr_img.size

        # Logoni

Otaboyev Sardorbek, [05.11.2025 12:15]
kichraytiramiz (QR oâ€˜rtasining ~20%)
        logo_size = qr_width // 5
        logo = logo.resize((logo_size, logo_size))

        # Markazga joylashtirish koordinatalari
        pos = ((qr_width - logo_size) // 2, (qr_height - logo_size) // 2)
        qr_img.paste(logo, pos, mask=logo if logo.mode == "RGBA" else None)

    # ğŸ”¹ Saqlaymiz
    qr_img.save(qr_path)

    return qr_path
ğŸ§© Qanday ishlatish
1ï¸âƒ£ Oddiy QR (logosiz)
link = "https://t.me/MyBot?start=ABC123"
path = generate_qr_with_logo(link, filename="my_deeplink_qr")
print("QR fayl saqlandi:", path)
Natija: qr_codes/my_deeplink_qr.png

2ï¸âƒ£ Logoli QR (masalan, bot belgisi bilan)
link = "https://t.me/MyBot?start=ABC123"
path = generate_qr_with_logo(link, filename="promo_link", logo_path="logo.png")
logo.png â€” bu sizning ikonangiz (100x100 yoki shunga yaqin oâ€˜lcham tavsiya qilinadi).

Agar logotip PNG formatda boâ€˜lsa (shaffof fon bilan), natija juda professional chiqadi.

âš¡ Afzalliklari
âœ… QR markazida logotip (masalan, bot belgisi yoki brend)
âœ… Yumaloq modullar va gradient â€” chiroyli dizayn
âœ… Faqat qrcode va Pillow kutubxonasiga tayanadi
âœ… Sizning tizimingizdagi /generate yoki /qr buyrugâ€˜iga osongina qoâ€˜shiladi

ğŸ§© Qoâ€˜llanish misoli Aiogram kontekstida
@router.message(commands=["qr"])
async def make_qr(message: types.Message):
    args = message.text.split()
    if len(args) < 2:
        await message.answer("â— Foydalanish: /qr <deep-link>")
        return

    link = args[1]
    path = generate_qr_with_logo(link, filename="custom_qr", logo_path="bot_icon.png")
    await message.answer_photo(
        photo=types.FSInputFile(path),
        caption=f"âœ… QR yaratildi:\n{link}"
    )
Agar xohlasangiz, men sizga shu QR funksiya bilan integratsiyalangan /qr komandasi boâ€˜lgan toâ€˜liq aiogram v3 modulini ham tayyorlab beraman (tayyor import qilinadigan versiya sifatida).
Shunday qilaymi?

You said:
Ha 
ChatGPT said:
Ajoyib! ğŸ¯
Endi sizga tayyor, modulli Aiogram v3 komponenti yozib beraman â€” uni loyihangizga qoâ€˜shish kifoya.
U sizga /qr <link> yoki /qr <product_id> <order_log_id> koâ€˜rinishida QR-kod yaratish imkonini beradi, markazida logo boâ€˜ladi, va qr_codes/ papkasida saqlanadi.

ğŸ“‚ Tavsiya etilgan loyiha tuzilmasi
ğŸ“‚ bot/
 â”œâ”€â”€ main.py
 â”œâ”€â”€ qr_utils.py        # QR-funksiyalar shu yerda
 â””â”€â”€ db.py / models.py  # avvalgidek
âš™ï¸ qr_utils.py â€” QR-kod logikasi (universal funksiya + Aiogram router)
import os
import qrcode
from aiogram import Router, types
from aiogram.filters import Command
from qrcode.image.styledpil import StyledPilImage
from qrcode.image.styles.moduledrawers import RoundedModuleDrawer
from qrcode.image.styles.colormasks import RadialGradiantColorMask
from PIL import Image

router = Router()


# ğŸ”¹ QR-kod generatsiyasi (logo bilan)
def generate_qr_with_logo(link: str, filename: str, logo_path: str | None = None) -> str:
    """
    Telegram deep-link yoki URL uchun professional QR-kod yaratadi.
    markazda ixtiyoriy logotip boâ€˜lishi mumkin.
    """
    os.makedirs("qr_codes", exist_ok=True)
    qr_path = f"qr_codes/{filename}.png"

    qr = qrcode.QRCode(
        version=2,
        error_correction=qrcode.constants.ERROR_CORRECT_H,
        box_size=12,
        border=4,
    )
    qr.add_data(link)
    qr.make(fit=True)

    qr_img = qr.make_image(
        image_factory=StyledPilImage,
        module_drawer=RoundedModuleDrawer(),
        color_mask=RadialGradiantColorMask(),
    )

    if logo_path and os.path.exists(logo_path):
        logo = Image.open(logo_path)
        qr_width, qr_height = qr_img.size
        logo_size = qr_width // 5
        logo = logo.resize((logo_size, logo_size))
        pos = ((qr_width - logo_size) // 2, (qr_height - logo_size) // 2)
        qr_img.paste(logo, pos, mask=logo if logo.mode == "RGBA" else None)

    qr_img.save(qr_path)
    return qr_path


# ğŸ”¹ /qr buyrugâ€˜i â€” oddiy deep-linkdan QR yaratadi
@router.message(Command("qr"))
async def qr_command(message: types.Message):
    """
    /qr <link>  â†’ oddiy linkdan QR-kod
    /qr <product_id> <order_log_id> â†’ oâ€˜z bot linkini generatsiya qiladi
    """
    args = message.text.spl

Otaboyev Sardorbek, [05.11.2025 12:15]
it(maxsplit=2)

    if len(args) == 2 and args[1].startswith("http"):
        # Toâ€˜liq link berilgan
        link = args[1]
        qr_path = generate_qr_with_logo(link, "manual_qr", logo_path="logo.png")
        await message.answer_photo(
            photo=types.FSInputFile(qr_path),
            caption=f"âœ… QR yaratildi:\n{link}"
        )
        return

    elif len(args) == 3:
        # Faqat product_id va order_log_id berilgan
        product_id = args[1]
        order_log_id = args[2]
        bot_username = (await message.bot.me()).username
        link = f"https://t.me/{bot_username}?start={product_id}_{order_log_id}"

        qr_path = generate_qr_with_logo(link, f"qr_{product_id}_{order_log_id}", logo_path="logo.png")
        await message.answer_photo(
            photo=types.FSInputFile(qr_path),
            caption=(
                f"ğŸ§¾ QR yaratildi!\n\n"
                f"<b>Product:</b> {product_id}\n"
                f"<b>Order:</b> {order_log_id}\n\n"
                f"<b>Link:</b> {link}"
            ),
        )
        return

    else:
        await message.answer(
            "â— Foydalanish:\n"
            "/qr <toâ€˜liq_link>\n"
            "yoki\n"
            "/qr <product_id> <order_log_id>"
        )
âš™ï¸ main.py â€” integratsiya (minimal)
import asyncio
from aiogram import Bot, Dispatcher
from qr_utils import router as qr_router

TOKEN = "YOUR_BOT_TOKEN"

bot = Bot(token=TOKEN, parse_mode="HTML")
dp = Dispatcher()
dp.include_router(qr_router)


async def main():
    print("ğŸ¤– Bot ishga tushdi...")
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
ğŸ§ª Foydalanish misollari
1ï¸âƒ£ Oddiy linkdan QR
/qr https://t.me/MyBot?start=ABC123
â¡ï¸ Bot sizga qr_codes/manual_qr.png faylini (logoli) yuboradi.

2ï¸âƒ£ Product + Order ID orqali
/qr 101 550
â¡ï¸ Bot avtomatik:

https://t.me/MyBot?start=101_550
linkni yaratadi va logoli QR yuboradi.

3ï¸âƒ£ Natija
ğŸ“¸ QR-kodingiz:

Chiroyli yumaloq modullar bilan

Markazda logo.png (masalan, bot belgisi)

qr_codes/ papkasida saqlanadi

âœ… Qisqacha
Xususiyat Tavsif
generate_qr_with_logo Universal QR-generator funksiya
/qr Aiogram v3 komandasi
logo.png Siz istagan ikonka (PNG yoki JPG)
Saqlash joyi qr_codes/ papkasi
Format .png, professional dizayn
Xohlaysizmi, bu modulgacha deep-link + QR + statistika tizimini bitta toâ€˜liq botga integratsiya qilib, tayyor bot.py fayl holida (import tayyor, SQLAlchemy bilan) yozib beray?

You said:
Ha imkoni boricha real loyxa sifatida chunki buni oÊ»zim ishlayapman shu namuna sifatida 
Ha imkoni boricha real loyxa sifatida chunki buni oÊ»zim ishlayapman shu namuna sifatidaÂ 
ChatGPT said:
Zoâ€˜r, endi haqiqiy real loyiha koâ€˜rinishidagi Aiogram v3 + SQLAlchemy + QR-kodli deep-link tizimini toâ€˜liq qilib beraman.
Bu strukturani siz toâ€˜gâ€˜ridan-toâ€˜gâ€˜ri ishlatishingiz, kengaytirishingiz yoki tijorat loyihangizga integratsiya qilishingiz mumkin.
Hammasi modulli: bot alohida, DB alohida, QR alohida, va routerlar soddalashgan.

ğŸ“¦ Loyihaning toâ€˜liq tuzilmasi
ğŸ“‚ mybot/
 â”œâ”€â”€ main.py          # Botni ishga tushirish
 â”œâ”€â”€ db.py            # SQLAlchemy sozlamalari
 â”œâ”€â”€ models.py        # Ma'lumotlar modeli
 â”œâ”€â”€ handlers/
 â”‚    â”œâ”€â”€ generate.py # /generate va /start logikasi (deep linklar)
 â”‚    â”œâ”€â”€ stats.py    # /stats
 â”‚    â””â”€â”€ qr_utils.py # /qr + QR funksiyasi
 â””â”€â”€ requirements.txt # kutubxonalar
ğŸ“‹ requirements.txt
aiogram==3.12.0
SQLAlchemy==2.0.36
aiosqlite
qrcode[pil]
pillow
âš™ï¸ db.py
from sqlalchemy.ext.asyncio import create_async_engine, async_sessionmaker
from sqlalchemy.orm import declarative_base

DATABASE_URL = "sqlite+aiosqlite:///bot_data.db"

Base = declarative_base()
engine = create_async_engine(DATABASE_URL, echo=False)
AsyncSessionLocal = async_sessionmaker(engine, expire_on_commit=False)

async def init_db():
    async with engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)

async def get_session():
    async with AsyncSessionLocal() as session:
        yield session
âš™ï¸ models.py
from sqlalchemy.orm import Mapped, mapped_column
from sqlalchemy import Integer, String, Boolean, DateTime
from da

Otaboyev Sardorbek, [05.11.2025 12:15]
tetime import datetime
from db import Base

class OrderLink(Base):
    __tablename__ = "order_links"

    id: Mapped[int] = mapped_column(Integer, primary_key=True)
    unique_key: Mapped[str] = mapped_column(String, unique=True)
    product_id: Mapped[int] = mapped_column(Integer)
    order_log_id: Mapped[int] = mapped_column(Integer)
    created_by: Mapped[int] = mapped_column(Integer)
    is_used: Mapped[bool] = mapped_column(Boolean, default=False)
    created_at: Mapped[datetime] = mapped_column(DateTime, default=datetime.utcnow)
    used_at: Mapped[datetime | None] = mapped_column(DateTime, nullable=True)
ğŸ¤– handlers/generate.py â€” deep-link yaratish va ishlatish
import secrets
from datetime import datetime
from aiogram import Router, types, Bot
from aiogram.filters import CommandStart
from aiogram.utils.deep_linking import create_start_link, decode_payload
from sqlalchemy import select, update
from db import get_session
from models import OrderLink

router = Router()

# /generate buyrugâ€˜i
@router.message(commands=["generate"])
async def generate_link(message: types.Message, bot: Bot):
    args = message.text.split()
    if len(args) < 3:
        await message.answer("â— Foydalanish: /generate <product_id> <order_log_id>")
        return

    product_id = int(args[1])
    order_log_id = int(args[2])
    unique_key = secrets.token_urlsafe(8)
    created_by = message.from_user.id

    async for session in get_session():
        session.add(OrderLink(
            unique_key=unique_key,
            product_id=product_id,
            order_log_id=order_log_id,
            created_by=created_by,
        ))
        await session.commit()

    link = await create_start_link(bot, unique_key, encode=True)
    await message.answer(
        f"âœ… Link yaratildi:\n\n"
        f"<b>Product:</b> {product_id}\n"
        f"<b>Order:</b> {order_log_id}\n"
        f"<b>Link:</b> {link}"
    )


# /start <payload>
@router.message(CommandStart(deep_link=True))
async def start_deeplink(message: types.Message, command: CommandStart):
    payload = decode_payload(command.args)
    async for session in get_session():
        result = await session.execute(select(OrderLink).where(OrderLink.unique_key == payload))
        link = result.scalar_one_or_none()

        if not link:
            await message.answer("âš ï¸ Bunday deep-link topilmadi.")
            return
        if link.is_used:
            await message.answer("ğŸš« Bu link allaqachon ishlatilgan.")
            return

        await session.execute(
            update(OrderLink)
            .where(OrderLink.id == link.id)
            .values(is_used=True, used_at=datetime.utcnow())
        )
        await session.commit()

        await message.answer(
            f"ğŸ¯ Deep-link faollashtirildi!\n\n"
            f"<b>Product:</b> {link.product_id}\n"
            f"<b>Order:</b> {link.order_log_id}\n"
            f"âœ… Endi ishlatilgan deb belgilandi."
        )
ğŸ“Š handlers/stats.py â€” statistikalar
from aiogram import Router, types
from sqlalchemy import select, func
from db import get_session
from models import OrderLink

router = Router()

@router.message(commands=["stats"])
async def user_stats(message: types.Message):
    user_id = message.from_user.id
    async for session in get_session():
        total = await session.scalar(select(func.count(OrderLink.id)).where(OrderLink.created_by == user_id))
        used = await session.scalar(select(func.count(OrderLink.id)).where(OrderLink.created_by == user_id, OrderLink.is_used.is_(True)))
        active = total - used

        text = (
            f"ğŸ“Š <b>Statistika:</b>\n"
            f"ğŸ”¹ Jami: {total}\n"
            f"ğŸŸ¢ Faol: {active}\n"
            f"ğŸ”´ Ishlatilgan: {used}\n"
        )
        await message.answer(text)
ğŸ“¸ handlers/qr_utils.py â€” QR kod yaratish moduli
import os
import qrcode
from aiogram import Router, types
from aiogram.filters import Command
from qrcode.image.styledpil import StyledPilImage
from qrcode.image.styles.moduledrawers import RoundedModuleDrawer
from qrcode.image.styles.colormasks import RadialGradiantColorM

Otaboyev Sardorbek, [05.11.2025 12:15]
ask
from PIL import Image

router = Router()


def generate_qr_with_logo(link: str, filename: str, logo_path: str | None = None) -> str:
    """Chiroyli QR yaratish, markazida logotip bilan"""
    os.makedirs("qr_codes", exist_ok=True)
    path = f"qr_codes/{filename}.png"

    qr = qrcode.QRCode(
        version=2,
        error_correction=qrcode.constants.ERROR_CORRECT_H,
        box_size=10,
        border=4,
    )
    qr.add_data(link)
    qr.make(fit=True)

    qr_img = qr.make_image(
        image_factory=StyledPilImage,
        module_drawer=RoundedModuleDrawer(),
        color_mask=RadialGradiantColorMask(),
    )

    if logo_path and os.path.exists(logo_path):
        logo = Image.open(logo_path)
        w, h = qr_img.size
        logo = logo.resize((w // 5, w // 5))
        pos = ((w - w // 5) // 2, (h - w // 5) // 2)
        qr_img.paste(logo, pos, mask=logo if logo.mode == "RGBA" else None)

    qr_img.save(path)
    return path


@router.message(Command("qr"))
async def qr_command(message: types.Message):
    """
    /qr <toâ€˜liq_link> yoki
    /qr <product_id> <order_log_id>
    """
    args = message.text.split(maxsplit=2)
    if len(args) == 2 and args[1].startswith("http"):
        link = args[1]
        path = generate_qr_with_logo(link, "manual_qr", logo_path="logo.png")
        await message.answer_photo(types.FSInputFile(path), caption=link)
        return

    elif len(args) == 3:
        product_id, order_log_id = args[1], args[2]
        username = (await message.bot.me()).username
        link = f"https://t.me/{username}?start={product_id}_{order_log_id}"
        path = generate_qr_with_logo(link, f"qr_{product_id}_{order_log_id}", logo_path="logo.png")
        await message.answer_photo(
            types.FSInputFile(path),
            caption=f"ğŸ§¾ Product: {product_id}\nOrder: {order_log_id}\n\n{link}"
        )
        return

    await message.answer("â— Foydalanish: /qr <link> yoki /qr <product_id> <order_log_id>")
ğŸš€ main.py â€” botni ishga tushirish
import asyncio
from aiogram import Bot, Dispatcher
from db import init_db
from handlers import generate, stats, qr_utils

TOKEN = "YOUR_BOT_TOKEN"

bot = Bot(token=TOKEN, parse_mode="HTML")
dp = Dispatcher()

# Routerlarni ulamiz
dp.include_router(generate.router)
dp.include_router(stats.router)
dp.include_router(qr_utils.router)


async def main():
    await init_db()
    print("ğŸ¤– Bot ishga tushdi...")
    await dp.start_polling(bot)


if __name__ == "__main__":
    asyncio.run(main())
ğŸ’¡ Qisqacha ishlash jarayoni
Buyruq Natija
/generate 101 555 Yangi deep-link yaratadi va bazaga yozadi
/start <payload> Link orqali kirganda uni ishlatilgan deb belgilaydi
/stats Foydalanuvchi statistikasi
/qr 101 555 Product va Order uchun QR yaratadi
/qr https://t.me/... Toâ€˜liq linkdan QR yaratadi
ğŸ§± Qoâ€˜shimcha tavsiyalar
logo.png faylni loyihaning ildiziga qoâ€˜ying (masalan, bot logosi 256Ã—256 px).

Keyinchalik siz OrderLink jadvaliga:

expiry_time (muddati),

scan_count (necha marta bosilgan),

ref_user_id (kim foydalangan)

kabi ustunlar qoâ€˜shib, tizimni kengaytirishingiz mumkin.

Agar xohlasangiz, keyingi bosqichda shu loyihaga:

ğŸ” JWT tokenli admin panel (FastAPI bilan),

ğŸ“ˆ Statistika dashboard (grafiklar bilan),

ğŸ§¾ Excel eksport (foydalanuvchi va link hisobotlari)

qoâ€˜shib beraman.
Shunday qilaymi â€” sizga toâ€˜liq real CRM-bot tizimi sifatida?

You said:
Menga qoÊ»shimcha maslaxatlaringni barcha barchasini qoÊ»shib bera olasanmi 
ChatGPT said:
Albatta! ğŸš€
Endi sizga toâ€˜liq real loyiha darajasidagi Telegram bot arxitekturasini tayyorlab beraman â€” bu:

âœ… Aiogram v3 (asenkron, modulli)
âœ… SQLAlchemy (ORM, async)
âœ… Deep-link tizimi (bir martalik, kuzatuvli)
âœ… QR-kod generatsiyasi (logo bilan)
âœ… Statistika
âœ… Admin panel (FastAPI + JWT token)
âœ… Dashboard (grafik koâ€˜rinishida)
âœ… Excel eksport (hisobotlar)

Boshqacha aytganda â€” bu real CRM / marketing bot tizimi uchun asos.
Men sizga loyiha tuzilmasi + backend API + bot logikasini bitta tizim sifatida tushuntiraman.
Keling, bosqichma-bosqich ketaylik ğŸ‘‡

ğŸ§© 1. Loyihaning umumiy tuzilmasi
ğŸ“‚ mycrm_bot/
 â”œâ”€â”€ bot/
 â”‚

Otaboyev Sardorbek, [05.11.2025 12:15]
â”œâ”€â”€ main.py             # Telegram botni ishga tushiradi
 â”‚    â”œâ”€â”€ db.py               # SQLAlchemy ulanishi
 â”‚    â”œâ”€â”€ models.py           # ORM modellari
 â”‚    â””â”€â”€ handlers/
 â”‚         â”œâ”€â”€ generate.py     # /generate + /start
 â”‚         â”œâ”€â”€ stats.py        # /stats
 â”‚         â””â”€â”€ qr_utils.py     # /qr + logo bilan QR funksiyasi
 â”‚
 â”œâ”€â”€ web/
 â”‚    â”œâ”€â”€ main.py             # FastAPI server (admin panel uchun)
 â”‚    â”œâ”€â”€ auth.py             # JWT avtorizatsiya
 â”‚    â”œâ”€â”€ routes/
 â”‚    â”‚     â”œâ”€â”€ dashboard.py   # grafiklar, API statistikasi
 â”‚    â”‚     â”œâ”€â”€ export.py      # Excel hisobot
 â”‚    â”‚     â””â”€â”€ orders.py      # linklarni boshqarish
 â”‚    â””â”€â”€ templates/
 â”‚          â””â”€â”€ dashboard.html # front-end (Jinja2)
 â”‚
 â”œâ”€â”€ .env                     # TOKEN, DATABASE_URL, ADMIN_LOGIN
 â”œâ”€â”€ requirements.txt
 â””â”€â”€ run_all.sh               # Bot + API birgalikda ishga tushirish
ğŸ“‹ 2. requirements.txt
aiogram==3.12.0
SQLAlchemy==2.0.36
aiosqlite
fastapi
uvicorn
jinja2
python-multipart
qrcode[pil]
pillow
openpyxl
python-jose[cryptography]
pandas
âš™ï¸ 3. .env (config)
BOT_TOKEN=YOUR_TELEGRAM_BOT_TOKEN
DATABASE_URL=sqlite+aiosqlite:///bot_data.db
ADMIN_USER=admin
ADMIN_PASS=admin123
JWT_SECRET=supersecretkey
JWT_ALGORITHM=HS256
ğŸ§± 4. Bot tomoni (aiogram)
Sizda bu qism oldingi versiyada allaqachon bor (generate.py, stats.py, qr_utils.py).
Ular baza bilan ishlaydi va OrderLink modelidan foydalanadi.
Biz ularga endi qoâ€˜shimcha ustunlar qoâ€˜shamiz:

# models.py
from sqlalchemy.orm import Mapped, mapped_column
from sqlalchemy import Integer, String, Boolean, DateTime
from datetime import datetime
from db import Base

class OrderLink(Base):
    __tablename__ = "order_links"

    id: Mapped[int] = mapped_column(Integer, primary_key=True)
    unique_key: Mapped[str] = mapped_column(String, unique=True)
    product_id: Mapped[int] = mapped_column(Integer)
    order_log_id: Mapped[int] = mapped_column(Integer)
    created_by: Mapped[int] = mapped_column(Integer)
    is_used: Mapped[bool] = mapped_column(Boolean, default=False)
    scan_count: Mapped[int] = mapped_column(Integer, default=0)
    created_at: Mapped[datetime] = mapped_column(DateTime, default=datetime.utcnow)
    used_at: Mapped[datetime | None] = mapped_column(DateTime, nullable=True)
    expiry_at: Mapped[datetime | None] = mapped_column(DateTime, nullable=True)
ğŸ‘‰ Endi sizda:

scan_count â€” necha marta QR yoki link bosilgan

expiry_at â€” tugash muddati (bir martalik emas, muddatli ham boâ€˜lishi mumkin)

ğŸ§° 5. FastAPI Admin panel (web/main.py)
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from web.routes import dashboard, orders, export, auth

app = FastAPI(title="CRM Bot Admin Panel")

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# ğŸ”— Marshrutlarni ulaymiz
app.include_router(auth.router, prefix="/auth", tags=["Auth"])
app.include_router(dashboard.router, prefix="/dashboard", tags=["Dashboard"])
app.include_router(orders.router, prefix="/orders", tags=["Orders"])
app.include_router(export.router, prefix="/export", tags=["Export"])

@app.get("/")
async def home():
    return {"message": "Admin API ishlayapti ğŸš€"}
ğŸ” 6. web/auth.py â€” JWT login tizimi
import os
from datetime import datetime, timedelta
from fastapi import APIRouter, HTTPException, Form
from jose import jwt

router = APIRouter()
SECRET_KEY = os.getenv("JWT_SECRET", "secret")
ALGORITHM = os.getenv("JWT_ALGORITHM", "HS256")

@router.post("/login")
async def login(username: str = Form(...), password: str = Form(...)):
    if username != os.getenv("ADMIN_USER") or password != os.getenv("ADMIN_PASS"):
        raise HTTPException(status_code=401, detail="Notoâ€˜gâ€˜ri login yoki parol")
    token = jwt.encode({"sub": username, "exp": datetime.utcnow() + timedelta(hours=2)}, SECRET_KEY, algorithm=ALGORITHM)
    return {"access_token": token, "token_type": "bearer"}
ğŸ“Š 7. web/routes/dashboard.py â€” statistikalar (API)
from fastapi import APIRouter
from sqlalchemy import select, func
from db import AsyncSessionLo

Otaboyev Sardorbek, [05.11.2025 12:15]
cal
from models import OrderLink

router = APIRouter()

@router.get("/")
async def get_dashboard():
    async with AsyncSessionLocal() as session:
        total = await session.scalar(select(func.count(OrderLink.id)))
        used = await session.scalar(select(func.count(OrderLink.id)).where(OrderLink.is_used.is_(True)))
        active = total - used
        return {"total": total, "used": used, "active": active}
ğŸ§¾ 8. web/routes/export.py â€” Excelga eksport
import pandas as pd
from fastapi import APIRouter, Response
from sqlalchemy import select
from db import AsyncSessionLocal
from models import OrderLink
from io import BytesIO

router = APIRouter()

@router.get("/links")
async def export_links():
    async with AsyncSessionLocal() as session:
        result = await session.execute(select(OrderLink))
        data = [row.__dict__ for row in result.scalars().all()]
        df = pd.DataFrame(data)
        buffer = BytesIO()
        df.to_excel(buffer, index=False)
        buffer.seek(0)
        headers = {
            "Content-Disposition": "attachment; filename=links.xlsx"
        }
        return Response(buffer.read(), headers=headers, media_type="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet")
ğŸ“ˆ 9. web/routes/orders.py â€” linklarni koâ€˜rish
from fastapi import APIRouter
from sqlalchemy import select
from db import AsyncSessionLocal
from models import OrderLink

router = APIRouter()

@router.get("/")
async def get_links():
    async with AsyncSessionLocal() as session:
        result = await session.execute(select(OrderLink))
        return [row.__dict__ for row in result.scalars().all()]
ğŸ“Š 10. web/templates/dashboard.html â€” oddiy front-end (grafik bilan)
<!DOCTYPE html>
<html>
<head>
    <title>CRM Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<h2>ğŸ“Š CRM Bot Statistikasi</h2>
<canvas id="chart" width="400" height="200"></canvas>
<script>
async function loadData() {
  const res = await fetch("/dashboard");
  const data = await res.json();
  const ctx = document.getElementById("chart");
  new Chart(ctx, {
    type: "doughnut",
    data: {
      labels: ["Faol", "Ishlatilgan"],
      datasets: [{
        data: [data.active, data.used],
        backgroundColor: ["#4CAF50", "#FF5252"]
      }]
    }
  });
}
loadData();
</script>
</body>
</html>
ğŸ§  11. run_all.sh â€” bitta buyruq bilan ishga tushirish
#!/bin/bash
echo "ğŸš€ Bot va API birgalikda ishga tushmoqda..."
python3 bot/main.py & uvicorn web.main:app --host 0.0.0.0 --port 8000
âœ… Yakuniy natija
Funksiya Joylashgan Tavsif
/generate Telegram bot Deep-link yaratadi
/start <payload> Telegram bot Foydalanuvchini kuzatadi
/stats Telegram bot Statistikani chiqaradi
/qr Telegram bot QR-kod (logo bilan) yaratadi
/auth/login FastAPI JWT login
/dashboard FastAPI Statistik API + HTML
/orders FastAPI Linklar roâ€˜yxati
/export/links FastAPI Excel hisobot
run_all.sh â€” Bot + API parallel ishlaydi
Bu tizim â€” real CRM yoki affiliate tracking bot uchun tayyor platforma.
Siz unga quyidagilarni bemalol qoâ€˜shishingiz mumkin:

ğŸ“† Har bir link uchun muddatli aktivlik (expiry_at)

ğŸ‘¥ Foydalanuvchi referal tizimi (ref_user_id)

ğŸ“ˆ Grafiklarda vaqt oraligâ€˜iga qarab tahlil

ğŸ§¾ Avtomatik PDF hisobot (Fpdf2 orqali)

Xohlaysizmi, men sizga shu loyihaning toâ€˜liq ZIP arxivi koâ€˜rinishida (tayyor kod bilan) yaratib beray?
Shunda siz faqat .env faylni toâ€˜ldirib, bash run_all.sh deb ishga tushirasiz.
 ha